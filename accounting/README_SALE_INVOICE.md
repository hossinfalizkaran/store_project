# View ایجاد فاکتور فروش - `create_sale_invoice`

## مقدمه

این View بر اساس فلوچارت عملیات فروش پیاده‌سازی شده است و تمام مراحل ثبت فاکتور فروش را به صورت اتوماتیک انجام می‌دهد.

## فلوچارت عملیات فروش

### مرحله ۱: اعتبارسنجی داده‌ها
- بررسی وجود مشتری
- بررسی آیتم‌های فاکتور
- بررسی موجودی کالاها در انبار

### مرحله ۲: ایجاد فاکتور فروش
- تولید شماره فاکتور جدید
- محاسبه مبالغ (جمع کل، مالیات، عوارض)
- ایجاد رکورد در جدول `FactFo`

### مرحله ۳: ایجاد ردیف‌های فاکتور
- ایجاد رکوردهای `FactFoDetail` برای هر آیتم
- ثبت اطلاعات کالا، مقدار، قیمت و تخفیف

### مرحله ۴: عملیات انبار (ثبت در کاردکس)
- ثبت خروجی در جدول `Kardex` برای هر آیتم
- به‌روزرسانی موجودی کالا در جدول `Goodinf`

### مرحله ۵: عملیات حسابداری (ایجاد سند)
- ایجاد سند حسابداری در جدول `Sanad`
- ثبت آرتیکل‌های سند در `SanadDetail`:
  - بدهکاری مشتری
  - بستانکاری فروش
  - بستانکاری مالیات (در صورت وجود)
  - بستانکاری عوارض (در صورت وجود)

### مرحله ۶: عملیات خزانه‌داری (اختیاری)
- در صورت وجود پرداخت نقدی، ثبت در `GetRecieve`
- ایجاد سند حسابداری برای دریافت نقدی

## ساختار View

### URL
```
/accounting/sales/create-invoice/
```

### Method
- **GET**: نمایش فرم ایجاد فاکتور
- **POST**: پردازش و ثبت فاکتور

### پارامترهای ورودی (JSON)

```json
{
    "customer_code": 123,
    "date": "2024/01/15",
    "description": "فروش کالا",
    "cash_payment": 1000000,
    "items": [
        {
            "good_code": 456,
            "quantity": 10,
            "unit_price": 50000,
            "store_code": 1,
            "discount": 5,
            "tax_percent": 9,
            "charge_percent": 0,
            "description": "کالای نمونه"
        }
    ]
}
```

### پاسخ موفق
```json
{
    "success": true,
    "message": "فاکتور فروش با موفقیت ثبت شد",
    "invoice_code": 1001,
    "sanad_id": 2001
}
```

### پاسخ خطا
```json
{
    "success": false,
    "message": "خطا در ثبت فاکتور: موجودی کافی نیست"
}
```

## جداول درگیر

### جداول اصلی
1. **`FactFo`**: سربرگ فاکتور فروش
2. **`FactFoDetail`**: ردیف‌های فاکتور
3. **`Kardex`**: کاردکس انبار
4. **`Sanad`**: سربرگ اسناد حسابداری
5. **`SanadDetail`**: آرتیکل‌های سند
6. **`GetRecieve`**: دریافت و پرداخت (اختیاری)

### جداول مرجع
1. **`Perinf`**: اطلاعات مشتری
2. **`Goodinf`**: اطلاعات کالا
3. **`Stores`**: اطلاعات انبارها

## ویژگی‌های کلیدی

### ۱. تراکنش اتمیک
تمام عملیات در یک تراکنش انجام می‌شود تا در صورت بروز خطا، تمام تغییرات rollback شود.

### ۲. اعتبارسنجی موجودی
قبل از ثبت فاکتور، موجودی کالاها در انبار بررسی می‌شود.

### ۳. محاسبه خودکار
- محاسبه خودکار مالیات و عوارض
- محاسبه تخفیف
- محاسبه جمع کل

### ۴. اسناد حسابداری خودکار
اسناد حسابداری به صورت خودکار و بدون دخالت کاربر ایجاد می‌شوند.

### ۵. به‌روزرسانی موجودی
موجودی کالاها به صورت خودکار در جدول `Goodinf` به‌روزرسانی می‌شود.

## Template

Template مربوطه در مسیر `accounting/templates/accounting/sales/create_invoice.html` قرار دارد و شامل:

- فرم مدرن و کاربرپسند
- محاسبه خودکار مبالغ با JavaScript
- اعتبارسنجی سمت کلاینت
- نمایش پیام‌های سیستم

## نکات مهم

### ۱. امنیت
- استفاده از `@login_required` برای احراز هویت
- اعتبارسنجی داده‌ها در سمت سرور
- استفاده از CSRF token

### ۲. عملکرد
- استفاده از `transaction.atomic()` برای اطمینان از یکپارچگی داده‌ها
- بهینه‌سازی کوئری‌ها
- مدیریت خطاها

### ۳. قابلیت توسعه
- امکان اضافه کردن انواع مختلف پرداخت
- امکان اضافه کردن تخفیف‌های مختلف
- امکان اضافه کردن مالیات‌های مختلف

## مثال استفاده

### درخواست POST
```javascript
fetch('/accounting/sales/create-invoice/', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken
    },
    body: JSON.stringify({
        customer_code: 123,
        date: '2024/01/15',
        description: 'فروش کالا',
        cash_payment: 1000000,
        items: [
            {
                good_code: 456,
                quantity: 10,
                unit_price: 50000,
                store_code: 1,
                discount: 5,
                tax_percent: 9,
                charge_percent: 0
            }
        ]
    })
})
.then(response => response.json())
.then(data => {
    if (data.success) {
        console.log('فاکتور با موفقیت ثبت شد:', data.invoice_code);
    } else {
        console.error('خطا:', data.message);
    }
});
```

## تست

برای تست این View می‌توانید:

1. فرم را در مرورگر باز کنید
2. اطلاعات فاکتور را وارد کنید
3. فاکتور را ثبت کنید
4. در جداول مربوطه بررسی کنید که رکوردها ایجاد شده‌اند

## نگهداری

- بررسی منظم لاگ‌های خطا
- به‌روزرسانی موجودی کالاها
- بررسی یکپارچگی اسناد حسابداری
- پشتیبان‌گیری منظم از داده‌ها 